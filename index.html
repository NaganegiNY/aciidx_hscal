<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IIDX 旧作HS,SUD+計算機</title>
    <style>
        :root {
            --theme-color: #86cecb;
            --bg-glow: rgba(134, 206, 203, 0.05);
        }
        body { font-family: 'Hiragino Kaku Gothic ProN', sans-serif; background: #0a0a0c; color: #fff; text-align: center; padding: 10px; }
        .card { background: linear-gradient(145deg, #1a1a1e, #25252b); border-radius: 20px; padding: 20px; max-width: 450px; margin: 0 auto; box-shadow: 0 8px 30px rgba(0,0,0,0.7); border: 1px solid #333; }
        
        .mode-switch { display: flex; gap: 10px; margin-bottom: 20px; }
        .mode-btn { flex: 1; padding: 10px; border-radius: 8px; border: 1px solid #444; background: #111; color: #888; cursor: pointer; font-weight: bold; transition: 0.3s; }
        
        #btnAC.active { background: #86cecb; color: #000; border-color: #86cecb; box-shadow: 0 0 10px rgba(134,206,203,0.4); }
        #btnCS.active { background: #ce8689; color: #fff; border-color: #ce8689; box-shadow: 0 0 10px rgba(206,134,137,0.4); }

        .input-group { margin-bottom: 12px; text-align: left; }
        label { font-size: 0.8rem; color: var(--theme-color); margin-left: 5px; font-weight: bold; transition: 0.3s; }
        input, select { width: 100%; padding: 12px; margin-top: 5px; border-radius: 8px; border: 1px solid #444; background: #000; color: #fff; font-size: 1.1rem; box-sizing: border-box; }
        
        .result { margin-top: 20px; padding: 15px; border: 2px solid var(--theme-color); border-radius: 12px; background: var(--bg-glow); transition: 0.3s; position: relative; }
        .hs-val { font-size: 2rem; color: var(--theme-color); font-weight: bold; transition: 0.3s; min-height: 3.5rem; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        
        .hs-selector { display: flex; gap: 8px; justify-content: center; margin: 10px 0; flex-wrap: wrap; }
        .hs-opt { padding: 8px 12px; border: 1px solid var(--theme-color); border-radius: 5px; background: transparent; color: var(--theme-color); cursor: pointer; font-weight: bold; font-size: 0.9rem; flex: 1; min-width: 70px; transition: 0.2s; }
        .hs-opt.selected { background: var(--theme-color); color: #000; }

        .auto-btn { width: 100%; padding: 8px; margin-bottom: 10px; border-radius: 6px; border: none; background: linear-gradient(to bottom, #555, #333); color: #fff; cursor: pointer; font-size: 0.8rem; font-weight: bold; border: 1px solid #555; }
        
        .save-btn { margin-top: 15px; width: 100%; padding: 10px; background: var(--theme-color); color: #000; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }

        .history-container { margin-top: 20px; text-align: left; border-top: 1px solid #333; padding-top: 15px; }
        .history-title { font-size: 0.9rem; color: #888; margin-bottom: 10px; display: block; }
        .history-item { background: #1a1a1e; border: 1px solid #333; padding: 10px; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: 0.2s; }
        .history-item:hover { border-color: var(--theme-color); }
        .history-info { font-size: 0.85rem; line-height: 1.4; }
        .del-btn { color: #ff4444; padding: 5px 10px; font-size: 1.2rem; cursor: pointer; }

        .sud-val { font-size: 1.6rem; color: #ffcc00; margin-top: 5px; }
        .midori-val { font-size: 1.8rem; color: #55ff55; margin-top: 10px; font-weight: bold; border-top: 1px dashed #444; padding-top: 10px; }
        .towel-val { font-size: 1.3rem; color: #ff66aa; margin-top: 5px; font-style: italic; }
        .info { font-size: 0.75rem; color: #888; margin-top: 15px; line-height: 1.4; }
    </style>
</head>
<body>

<div class="card">
    <h2 id="title" style="margin:0 0 15px 0; color:var(--theme-color); font-size: 1.4rem;">IIDX 旧作HS,SUD+計算機</h2>
    
    <div class="mode-switch">
        <button id="btnAC" class="mode-btn active" onclick="setPlatform('AC')">AC</button>
        <button id="btnCS" class="mode-btn" onclick="setPlatform('CS')">CS (家庭用)</button>
    </div>

    <div class="input-group">
        <label>シリーズ</label>
        <select id="version" onchange="resetManualHS(); calc();"></select>
    </div>

    <div style="display: flex; gap: 10px;">
        <div class="input-group" style="flex: 1;">
            <label>目標 緑数字</label>
            <input type="number" id="targetMidori" value="300" oninput="calc()">
        </div>
        <div class="input-group" style="flex: 1;">
            <label>基準 SUD+</label>
            <input type="number" id="baseSud" value="0" oninput="calc()">
        </div>
    </div>
    
    <div class="input-group">
        <label>曲のBPM</label>
        <input type="number" id="bpm" value="150" oninput="calc()">
    </div>

    <div class="result">
        <div id="hsContainer" class="hs-val">-</div>
        <div id="resSUD" class="sud-val">-</div>
        <div id="resTowel" class="towel-val"></div>
        <div id="resMidori" class="midori-val">-</div>
        <button class="save-btn" onclick="saveHistory()">この設定を保存</button>
    </div>

    <div class="history-container">
        <span class="history-title">保存された履歴</span>
        <div id="historyList"></div>
    </div>
    
    <div class="info">
        ※緑数字は (1000 - SUD+) / (BPM * 倍率) * 174000 / 1000 で計算しています。<br>
        実機環境により微差が出る場合があります。©Naganegi_NY
    </div>
</div>

<script>
let currentPlatform = 'AC';
let manualHSIdx = 0;
let history = [];

const hsData = {
    AC: [
        { name: "1st style / substream", hs: [{l:"HS 0.0", m:1.0}] },
        { name: "2nd ~ 4th style", hs: [{l:"HS 0.0", m:1.0}, {l:"HS 1.0", m:2.0}], manual: true },
        { name: "5th style", hs: [{l:"HS 0.0", m:1.0}, {l:"HS 1.0", m:2.0}, {l:"HS 2.0", m:2.5}, {l:"HS 3.0", m:3.0}], manual: true },
        { name: "6th ~ 10th style", hs: [{l:"HS 0.0", m:1.0}, {l:"HS 1.0", m:2.0}, {l:"HS 2.0", m:2.5}, {l:"HS 3.0", m:3.0}] },
        { name: "IIDX RED", hs: [{l:"HS 0.0", m:1.0}, {l:"HS 1.0", m:2.0}, {l:"HS 2.0", m:2.5}, {l:"HS 3.0", m:3.0}, {l:"HS 4.0", m:3.5}] },
        { name: "HAPPY SKY", hs: [{l:"HS 0.0", m:1.0}, {l:"HS 0.5", m:1.5}, {l:"HS 1.0", m:2.0}, {l:"HS 1.5", m:2.25}, {l:"HS 2.0", m:2.5}, {l:"HS 2.5", m:2.75}, {l:"HS 3.0", m:3.0}, {l:"HS 3.5", m:3.25}, {l:"HS 4.0", m:3.5}] },
        { name: "DistorteD ~ DJTROOPERS", hs: [{l:"HS 0.0", m:1.0}, {l:"HS 0.5", m:1.5}, {l:"HS 1.0", m:2.0}, {l:"HS 1.5", m:2.25}, {l:"HS 2.0", m:2.5}, {l:"HS 2.5", m:2.75}, {l:"HS 3.0", m:3.0}, {l:"HS 3.5", m:3.25}, {l:"HS 4.0", m:3.5}, {l:"HS 4.5", m:3.75}, {l:"HS 5.0", m:4.0}] }
    ],
    CS: [
        { name: "3rd style", hs: [{l:"LS 2.0", m:0.33}, {l:"LS 1.0", m:0.66}, {l:"HS 0.0", m:1.0}, {l:"HS 1.0", m:2.0}, {l:"HS 2.0", m:3.0}, {l:"HS 3.0", m:4.0}], manual: true },
        { name: "4th style", hs: [{l:"LS 2.0", m:0.33}, {l:"LS 1.0", m:0.66}, {l:"HS 0.0", m:1.0}, {l:"HS 1.0", m:2.0}, {l:"HS 2.0", m:2.75}, {l:"HS 3.0", m:3.5}], manual: true },
        { name: "5th style", hs: [{l:"LS 1.0", m:0.66}, {l:"HS 0.0", m:1.0}, {l:"HS 1.0", m:2.0}, {l:"HS 2.0", m:2.5}, {l:"HS 3.0", m:3.0}], manual: true },
        { name: "6th style", hs: [{l:"LS 1.0", m:0.66}, {l:"HS 0.0", m:1.0}, {l:"HS 1.0", m:2.0}, {l:"HS 2.0", m:2.5}, {l:"HS 3.0", m:3.0}, {l:"HS 4.0", m:3.5}] },
        { name: "7th ~ 9th style", hs: [{l:"HS 0.0", m:1.0}, {l:"HS 1.0", m:2.0}, {l:"HS 2.0", m:2.5}, {l:"HS 3.0", m:3.0}, {l:"HS 4.0", m:3.5}] },
        { name: "10th style", hs: [{l:"HS 0.0", m:1.0}, {l:"HS 0.5", m:1.5}, {l:"HS 1.0", m:2.0}, {l:"HS 1.5", m:2.25}, {l:"HS 2.0", m:2.5}, {l:"HS 2.5", m:2.75}, {l:"HS 3.0", m:3.0}, {l:"HS 3.5", m:3.25}, {l:"HS 4.0", m:3.5}] },
        { name: "IIDX RED ~ DistorteD", hs: [{l:"HS 0.0", m:1.0}, {l:"HS 0.5", m:1.5}, {l:"HS 1.0", m:2.0}, {l:"HS 1.5", m:2.25}, {l:"HS 2.0", m:2.5}, {l:"HS 2.5", m:2.75}, {l:"HS 3.0", m:3.0}, {l:"HS 3.5", m:3.25}, {l:"HS 4.0", m:3.5}, {l:"HS 4.5", m:3.75}, {l:"HS 5.0", m:4.0}] }
    ]
};

function resetManualHS() { manualHSIdx = 0; }

function setPlatform(p) {
    currentPlatform = p;
    const root = document.documentElement;
    root.style.setProperty('--theme-color', p === 'AC' ? '#86cecb' : '#ce8689');
    document.getElementById('btnAC').classList.toggle('active', p === 'AC');
    document.getElementById('btnCS').classList.toggle('active', p === 'CS');
    const verSelect = document.getElementById('version');
    verSelect.innerHTML = "";
    hsData[p].forEach((v, idx) => {
        const opt = document.createElement('option');
        opt.value = idx; opt.innerText = v.name;
        verSelect.appendChild(opt);
    });
    verSelect.selectedIndex = hsData[p].length - 1;
    resetManualHS();
    calc();
}

function selectHS(idx) { manualHSIdx = idx; calc(); }

function selectBestHS() {
    const verIdx = document.getElementById('version').value;
    const midori = parseFloat(document.getElementById('targetMidori').value);
    const bpm = parseFloat(document.getElementById('bpm').value);
    const baseSud = parseFloat(document.getElementById('baseSud').value);
    const currentList = hsData[currentPlatform][verIdx];
    let minDiff = 9999, bestIdx = 0;
    currentList.hs.forEach((hs, idx) => {
        let calcSud = 1000 - (midori * bpm * hs.m / 174);
        let diff = Math.abs(calcSud - baseSud);
        if (calcSud >= 0 && calcSud <= 1000 && diff < minDiff) {
            minDiff = diff; bestIdx = idx;
        }
    });
    manualHSIdx = bestIdx;
    calc();
}

// 設定値をブラウザに保存する処理
function saveSettings() {
    const midori = document.getElementById('targetMidori').value;
    const baseSud = document.getElementById('baseSud').value;
    localStorage.setItem('iidx_cfg_midori', midori);
    localStorage.setItem('iidx_cfg_basesud', baseSud);
}

// 計算メイン処理
function calc() {
    const verIdx = document.getElementById('version').value;
    if (verIdx === "") return;
    
    // 入力のたびに設定を自動保存
    saveSettings();

    const midori = parseFloat(document.getElementById('targetMidori').value);
    const bpm = parseFloat(document.getElementById('bpm').value);
    const baseSud = parseFloat(document.getElementById('baseSud').value);
    const currentList = hsData[currentPlatform][verIdx];
    const hsContainer = document.getElementById('hsContainer');
    const resSUD = document.getElementById('resSUD'), resTowel = document.getElementById('resTowel'), resMidori = document.getElementById('resMidori');

    let bestHS = null;
    let finalSud = 0;

    if (currentList.manual) {
        let html = `<button class="auto-btn" onclick="selectBestHS()">おすすめのHS</button>`;
        html += `<div class="hs-selector">`;
        currentList.hs.forEach((h, i) => {
            html += `<button class="hs-opt ${manualHSIdx === i ? 'selected' : ''}" onclick="selectHS(${i})">${h.l}</button>`;
        });
        html += `</div>`;
        hsContainer.innerHTML = html;
        bestHS = currentList.hs[manualHSIdx];
        finalSud = Math.round(1000 - (midori * bpm * bestHS.m / 174));
    } else {
        let minDiff = 9999;
        currentList.hs.forEach(hs => {
            let calcSud = 1000 - (midori * bpm * hs.m / 174);
            let diff = Math.abs(calcSud - baseSud);
            if (calcSud >= 0 && diff < minDiff) {
                minDiff = diff;
                bestHS = hs;
                finalSud = Math.round(calcSud);
            }
        });
        hsContainer.innerText = bestHS ? bestHS.l : "速すぎます";
    }

    if (!bestHS || finalSud < 0) {
        if (!currentList.manual) hsContainer.innerText = "速すぎます";
        resSUD.innerText = "-"; resTowel.innerText = ""; resMidori.innerText = "";
    } else {
        resSUD.innerText = "SUD+: " + (finalSud > 1000 ? 1000 : finalSud);
        let actualMidori = Math.round((1000 - finalSud) / (bpm * bestHS.m) * 174);
        resMidori.innerText = "緑数字: " + (actualMidori < 0 ? "-" : actualMidori);

        const isOldAC = currentPlatform === 'AC' && ["1st style / substream", "2nd ~ 4th style", "5th style", "6th ~ 10th style", "IIDX RED", "HAPPY SKY"].includes(currentList.name);
        const isOldCS = currentPlatform === 'CS' && ["3rd style", "4th style", "5th style", "6th style", "7th ~ 9th style", "10th style"].includes(currentList.name);
        
        if (isOldAC || isOldCS) {
            let towelVal = (finalSud / 10).toFixed(1);
            resTowel.innerText = "タオル隠し: " + (towelVal > 100 ? 100 : towelVal) + "%";
        } else {
            resTowel.innerText = "";
        }
    }
}

// 履歴機能
function saveHistory() {
    const verIdx = document.getElementById('version').value;
    const verName = hsData[currentPlatform][verIdx].name;
    const bpm = document.getElementById('bpm').value;
    const sud = document.getElementById('resSUD').innerText;
    const hs = document.querySelector('.selected')?.innerText || document.getElementById('hsContainer').innerText;
    const towel = document.getElementById('resTowel').innerText;

    const item = {
        id: Date.now(),
        platform: currentPlatform,
        verIdx: verIdx,
        bpm: bpm,
        midori: document.getElementById('targetMidori').value,
        baseSud: document.getElementById('baseSud').value,
        text: `[${currentPlatform}] ${verName} / BPM:${bpm}`,
        sub: `${hs} / ${sud} ${towel ? '/ ' + towel : ''}`
    };
    history.unshift(item);
    if(history.length > 5) history.pop(); 
    localStorage.setItem('iidx_history', JSON.stringify(history));
    renderHistory();
}

function renderHistory() {
    const list = document.getElementById('historyList');
    list.innerHTML = history.map(item => `
        <div class="history-item" onclick="loadHistory(${item.id})">
            <div class="history-info">
                <strong>${item.text}</strong><br>
                <small>${item.sub}</small>
            </div>
            <div class="del-btn" onclick="event.stopPropagation(); deleteHistory(${item.id})">×</div>
        </div>
    `).join('');
}

function loadHistory(id) {
    const item = history.find(h => h.id === id);
    if (!item) return;
    document.getElementById('targetMidori').value = item.midori;
    document.getElementById('baseSud').value = item.baseSud;
    document.getElementById('bpm').value = item.bpm;
    setPlatform(item.platform);
    document.getElementById('version').value = item.verIdx;
    calc();
}

function deleteHistory(id) {
    history = history.filter(h => h.id !== id);
    localStorage.setItem('iidx_history', JSON.stringify(history));
    renderHistory();
}

// ページ読み込み時の初期化
window.onload = () => {
    // 1. まずプラットフォームをセット（まだ計算はしない）
    currentPlatform = 'AC';
    updateVersionList('AC'); 

    // 2. ブラウザから保存データを取得
    const savedMidori = localStorage.getItem('iidx_cfg_midori');
    const savedBaseSud = localStorage.getItem('iidx_cfg_basesud');
    const savedHistory = localStorage.getItem('iidx_history');

    // 3. 取得したデータを入力欄に反映
    if (savedMidori) document.getElementById('targetMidori').value = savedMidori;
    if (savedBaseSud) document.getElementById('baseSud').value = savedBaseSud;
    if (savedHistory) {
        history = JSON.parse(savedHistory);
        renderHistory();
    }

    // 4. 全て準備が整ってから初めて計算を実行
    calc();
};

// setPlatformの中身も少し整理して、初期化時にループしないようにします
function setPlatform(p) {
    currentPlatform = p;
    updateVersionList(p);
    calc();
}

// バージョンリストの更新だけを切り分け
function updateVersionList(p) {
    const root = document.documentElement;
    root.style.setProperty('--theme-color', p === 'AC' ? '#86cecb' : '#ce8689');
    document.getElementById('btnAC').classList.toggle('active', p === 'AC');
    document.getElementById('btnCS').classList.toggle('active', p === 'CS');
    
    const verSelect = document.getElementById('version');
    verSelect.innerHTML = "";
    hsData[p].forEach((v, idx) => {
        const opt = document.createElement('option');
        opt.value = idx; 
        opt.innerText = v.name;
        verSelect.appendChild(opt);
    });
    verSelect.selectedIndex = hsData[p].length - 1;
    resetManualHS();
}
</script>
</body>
</html>
